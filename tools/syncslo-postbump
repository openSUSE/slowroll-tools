#!/bin/sh
#usage:
#for p in $(osc ls $slo|grep -v :|sort -r) ; do echo "$p"; dry=" " tools/syncslo-postbump "$p" ; done | tee out/log/syncslo-postbump-$(date -I)
srcprj=openSUSE:Factory
prj=openSUSE:Slowroll
pkg=${1:-qt6-webview}
# from pontifex2 cd /srv/ftp/pub/opensuse/repositories/openSUSE:/ALP:/Experimental:/Slowroll/base.20240405/repo/src-oss/src && for p in * ; do rpm -qp --qf '%{name} %{version} %{release} %{disturl}\n' $p ; done > .slowroll
# from curl https://downloadcontent.opensuse.org/repositories/openSUSE:/ALP:/Experimental:/Slowroll/base-next-full/repo/src-oss/src/.slowroll > cache/slowroll-base-20240429.disturls
basedisturls=cache/slowroll-base.disturls
factoryjson=cache/view.2024-04-06/factory.json
: ${dry:=echo}

xpkg=$(echo "$pkg" | perl -pe 's/\.2024\d{10}//') # handle maintenance release naming FIXME update in 2025

if [ "$xpkg" = "$pkg" ] ; then
    osc ls $pkg "$pkg" 2>&1 | grep -q "cannot be expanded:" &&
        echo "drop dangling link" $prj "$pkg" &&
        $dry osc rdelete -m "drop dangling link" $prj "$pkg"
    exit 0
fi

grep "^$xpkg$" in/never-update-exceptions && exit 0

if ! grep -q "^$xpkg$" in/dont-delete ; then
#if ! grep -q "^$pkg$" in/baselibs.list in/i586bitbuilddeps in/dont-delete ; then
##osc api "/source/$prj/$pkg/_history"|tail -3|grep -q "Release from openSUSE:Factory" # does not work because of :Releasing subprj
#osc api /build/$srcprj/standard/x86_64/$pkg/_buildenv > tmp/srcenv
#osc api /build/$prj/standard/x86_64/$pkg/_buildenv > tmp/dstenv
#diff tmp/{src,dst}env >/dev/null
#isfactory=$?


#if [ $isfactory = 0 ] ; then
    echo "dropping $pkg"
    $dry osc rdelete --force -m "rebased" $prj "$pkg"
    exit 0 # done
#fi
fi

latest=$(tools/followlink $xpkg)
if [ "$pkg" != "$latest" ] ; then
    echo "drop old version" "$prj" "$pkg"
    $dry osc rdelete --force -m "drop old version" "$prj" "$pkg"
    exit 0
fi

echo "updating $pkg"
rev=$(basename $(grep ^$xpkg\  $basedisturls|cut -d" " -f4) |cut -d- -f1)
frev=$(jq ".[\"$xpkg\"][\"md5\"]" $factoryjson | sed 's/"//g')
if [[ $rev = $frev ]] ; then
#if PAGER="wc -c" osc rdiff --missingok -r "$rev" $srcprj "$pkg" $prj | grep -q . ; then # check if there is any diff
#echo osc copypac -r "$rev" $srcprj "$pkg" $prj
    $dry tools/releasemulti $srcprj $prj "$xpkg"
    $dry osc rdelete --force -m "updated from Factory" "$prj" "$pkg"
else
    echo "XX mismatch in $pkg $rev vs $frev"
    $dry tools/submitpackageupdate "$xpkg" "$rev"
fi
